分布式系统当中有一个著名的CAP理论，它也是分布式系统理论的基础。CAP理论最早发表于2000年，由加州伯克利的教授首先在ACM PODC会议上提出猜想，两年之后，被麻省理工学院的教授Seth Gilbert和Nancy Lynch从理论上证明。从此之后，它成了分布式系统领域的公认定理。

CAP理论指的是在一个分布式系统中，Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性）这三个基本需求，最多只能同时满足其中的2个。
![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjvlgdk7k8j30m80m879u.jpg)

## Consistency（一致性）

一致性指的是所有节点的数据一致，或者说是所有副本的数据一致。用英文描述是：All the nodes see the same data at the same time。它和数据库事务中的一致性是两码事。

从客户端和服务端的角度来看：

1. 对于客户端而言，并不关心后端的实现以及节点运行情况。只关心多次并发请求都能获得准确的符合预期的结果。比如用户多次点击付款，也只会付款一次，余额无论什么时候查询都是当下最新的值。
2. 对于服务端而言，关心的是会引发数据变更的请求，接收到请求以后能够及时准确的同步到所有的节点和副本，并且考虑可能会出现的网络及通信问题，保证极端情况下依旧不会产生错误。

在分布式系统中，针对不同的情况及要求下的一致性，大致分为三种模型：

类型 | 说明 
--- | ---
强一致性 | 要求更新成功的数据立即生效，且在后续访问中都能返回最新的正确结果
弱一致性 | 能够容忍在更新后，部分情况下无法访问到最新数据
最终一致性 | 能够容忍在更新后一段时间内无法访问到最新数据，但有机制可以保证一段时间之后数据完全生效，获得正确结果

> 在CAP理论中，我们讲的无法同时满足一致性，指的是强一致性
> 

##   Availability 可用性  

可用性指的是：Reads and writes always succeed. 也就是说系统一直可用，而且服务一直保持正常。

一个高可用的分布式系统，必须对用户的每一个请求作出相应。不能出现无法访问或者响应超时等影响用户体验的情况。在分布式系统中，任何一个节点的不稳定，都有可能影响系统的可用性，比如数据库、负载均衡、缓存服务等。我们通常使用一段时间（例如一年）的停机时间占比来衡量：

指标 | 停机时间/总运行时间 | 年可容忍停机时间
--- | --- | ---
1个9 | 90% | <= 880 小时
2个9 | 99% | <= 88 小时
3个9 | 99.9% | <= 9小时
4个9 | 99.99% | <= 53分钟
5个9 | 99.999% | <= 6分钟
6个9 | 99.9999% | <= 1分钟

## Partition Tolerance 分区容错性  

分区容错性指的是： System continues operating despire arbitrary message loss or failure of part of the system. 翻译过来就是说系统在遇到一些节点或者网络分区故障的时候，仍然能够提供满足一致性和可用性的服务。

分区容错性和拓展性息息相关，因为越大的分布式系统越有可能出现机器宕机，网络阻塞等情况。即使这些意外情况发生，系统仍然能保持稳定是系统拓展的前提。在分布式系统当中出现的问题可能性很多，既可能出现部分机器宕机，也有可能出现内网阻隔，使得整个集群被拆分成互相不能通信的几个部分。分区容错性需要保证即使这些情况发生，系统也一样可以保证一致性和可用性。

## CAP理论论证

我们假设整个集群里只有两个N1和N2两个节点，如下图：

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjvm55ys4pj305o06odfy.jpg)

* 在满足一致性C的时候，N1和N2中的数据是一样的，V0=V0。
* 在满足可用性A的时候，用户不管是请求N1或者N2，都会得到立即响应。
* 在满足分区容错性P的情况下，无论N1还是N2宕机或者是两者的通信中断，都不影响系统的运行。

如下图所示，这是分布式系统正常运转的流程，用户向N1机器请求数据更新，程序A更新数据库V0为V1。分布式系统将数据进行同步操作M，将V1同步的N2中V0，使得N2中的数据V0也更新为V1，N2中的数据再响应N2的请求。

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjvm9k801ej30h306r3zr.jpg)

这是正常运作的场景，也是理想的场景。作为一个分布式系统，它和单机系统的最大区别，就在于网络。现在假设一种极端情况，N1和N2之间的网络断开了，我们要支持这种网络异常。相当于要满足分区容错性，能不能同时满足一致性和可用性呢？还是说要对他们进行取舍？

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjvmb1oa73j30h706vjss.jpg)

假设在N1和N2之间网络断开的时候，有用户向N1发送数据更新请求，那N1中的数据V0将被更新为V1。由于网络是断开的，所以分布式系统同步操作M，所以N2中的数据依旧是V0。这个时候，有用户向N2发送数据读取请求，由于数据还没有进行同步，应用程序没办法立即给用户返回最新的数据V1，怎么办呢？
这里有两种选择：

* 第一：牺牲数据一致性，保证可用性。响应旧的数据V0给用户。
* 第二：牺牲可用性，保证数据一致性。阻塞等待，直到网络连接恢复，数据更新操作M完成之后，再给用户响应最新的数据V1。

这个过程，证明了要满足分区容错性的分布式系统，只能在一致性和可用性两者中，选择其中一个。

> CAP理论中， 如果不要求P（不允许分区），则C（强一致性）和A（可用性）是可以保证的。但其实分区不是你想不想的问题，而是始终会存在，P是分布式系统的前提，因此CA是不存在的。

### CP

系统保证了一致性和分区容错性，舍弃可用性。也就是说在极端情况下，允许出现系统无法访问的情况出现，这个时候往往会牺牲用户体验，让用户保持等待，一直到系统数据一致了之后，再恢复服务。

对于有些系统而言，一致性是安身立命之本，比如Hbase、Redis这种分布式存储，数据一致性是最基本的要求。ZooKeeper也是一样，任何时候访问ZK都可以获得一致性的结果。它的职责就是保证管辖下的服务保持同步和一致，显然不可能放弃一致性。但是在极端情况下，ZK可能会丢弃调一些请求，消费者需要重新请求才能获得结果。

### AP

大部分分布式系统的设计都会选择AP，保证高可用和分区容错，但是会牺牲一致性。比如淘宝购物以及12306购票等等。

举个例子，我们在12306买票的时候就经常会遇到。在我们点击购买的时候，系统并没有提示没票。等我们输入了验证码，付款的时候才会告知，已经没有票了。这就是因为我们在点击购买的时候，数据没有达成一致性，在付款校验的时候才检验出余票不足。这种设计会牺牲一些用户体验，但是可以保证高可用，让用户不至于无法访问或者是长时间等待，也算是一种取舍吧。